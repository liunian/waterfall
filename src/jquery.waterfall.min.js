(function(b,d){var f=d(b),c=d("body");var a={container:null,colWidth:0,minCol:1,maxCol:10,gapWidth:15,gapHeight:15,resizeDelay:0,loadDelay:0,preDistance:100,onbeforeLoad:null,load:null,resizeable:true,onresize:null,oninit:null};function e(g){this.options=d.extend({},a,g);this._init();this._bind()}e.prototype={_init:function(){var g=this.options;if(!g.container){throw new Error("miss container")}if(g.maxCol){if(g.minCol>g.maxCol){throw new Error("minCol should be less than maxCol")}}this.styleQueue=[];this._resetColHeightArr();this._resetWidth();this.state="ready";g.oninit&&g.oninit();this._firstLoad()},_resetColCount:function(){var h=this.options;var g=Math.floor((f.width()+h.gapWidth)/(h.colWidth+h.gapWidth));if(g<h.minCol){g=h.minCol}if(h.maxCol&&(g>h.maxCol)){g=h.maxCol}this.colCount=g},_resetWidth:function(){var h=this.options,g=this.colCount;h.container[0].style.width=g*h.colWidth+(g-1)*h.gapWidth+"px"},_resetColHeightArr:function(){this._resetColCount();this.colHeightArr=[];for(var h=0,g=this.colCount;h<g;h++){this.colHeightArr[h]=0}},layout:function(p){var h=this,o=h.options;l=p.length;for(var m=0;m<l;m++){h._placeItem(p[m])}o.container.css("height",h.getMaxHeight());for(var k=0,g=h.styleQueue.length;k<g;k++){var n=h.styleQueue[k];n.$ele.css(n.style)}h.styleQueue=[]},addItem:function(h){this.state="rendering";var g=d(h);var i=this.getMinHIndex();this.options.container.append(g);this.layout([g]);g.addClass("ready");this.state="ready"},_placeItem:function(i){var h=this,k=this.options,g=d(i),j=h.getMinHIndex();pos={left:j*(k.colWidth+k.gapWidth),top:h.colHeightArr[j]};h.colHeightArr[j]+=k.gapHeight+g.outerHeight();h.styleQueue.push({$ele:g,style:pos})},getMinHIndex:function(){var k=0,g=this.colHeightArr,h=g.length;for(var j=1;j<h;j++){if(g[j]<g[k]){k=j}}return k},getMaxHeight:function(){var h=this.colHeightArr,j=h.length,g=0;for(var k=0;k<j;k++){if(g<h[k]){g=h[k]}}return g},_bind:function(){var h=this;if(h.options.resizeable){if(d.browser.msie&&parseInt(d.browser.version,10)<=8){var i=document.createElement("div");i.style.cssText="width:100%;height:0px;position:absolute;bottom:0px;left:0px;overflow:hidden";document.body.appendChild(i);i.onresize=function(){h._resize()}}else{f.bind("resize",function(){h._resize()})}}f.bind("scroll",d.proxy(h._load,h))},_resize:function(){var g=this;if(g.resizeTimer){clearTimeout(g.resizeTimer)}g.resizeTimer=setTimeout(function(){g.doResize()},g.options.resizeDelay)},doResize:function(){var g=this,h=g.options;g._resetColHeightArr();g._resetWidth();g.layout(h.container.children());h.onresize&&h.onresize();setTimeout(function(){g._load.call(g)},300)},_load:function(){var g=this,h=g.options;if(g.state=="ready"&&(f.height()+h.preDistance>=h.container.get(0).getBoundingClientRect().top+h.container.height())){g.doLoad()}},doLoad:function(){var g=this,h=g.options;h.onbeforeLoad&&h.onbeforeLoad();g.state="loading";setTimeout(function(){h.load&&h.load.call(g)},g.options.loadDelay)},_firstLoad:function(){while(this.state=="ready"&&f.height()>=c.outerHeight()){this._load()}},success:function(h){var g=this;if(h&&d.isArray(h)){d.each(h,function(j,k){g.addItem(k)})}g.state="ready"},end:function(){var g=this;g.state="end";f.unbind("scroll",d.proxy(g._load,g))}};b.Waterfall=e})(window,jQuery);